# Agent Working Procedure

1. Review the code base and prepare for work based on the `## Developer's Requirements` section below.
2. If the last section is a developer section like `## Developer's Requirements Update` or `## Developer's Review Response`, skip the middle and start from there.
3. If you need a decision from the developer, add a section called `## Agent's Review Request` at the end of this file and stop working.
4. When work is finished, add a section called `## Agent's Work Execution : {yyyy-MM-dd HH:mm}` at the end of this file and describe what you did.
5. When updating documents, **do not delete or overwrite** existing sections. Always add new information to the **end** of the file.
6. When making a plan, do not give multiple choices like "A or B". Specify **one clear implementation path**.
7. For other general rules, check [ai_agent_guide.md](/docs/guide/ai_agent_guide.md).

## Developer Requirements
### The core goal of this project
- 우리는 quiet-chatter 서비스를 개발중이다. 이 프로젝트(quiet-chatter-docs)는 quiet-chatter 서비스의 기획 및 정책을 담고 있는 문서 저장소이다.현재 워크스페이스의 상위로 가면 이 프로젝트 경로의 형제 위치에 프론트엔드로서 quiet-chatter-front-end ,백엔드로서 quiet-chatter 프로젝트 디렉토리가 존재한다.
- 이프로젝트의 목적은 요구사항을 명확히 하고, 이것이 실제 기능 구현에 이르기까지의 문서기반의 워크플로우를 담당하는 것이다.

### 인터페이스 설계

- 새로운 요구사항이 다음과 같이 전달되었다. [Target](/service_specification.md#3.4-마이페이지-my-page)
- 개발에 앞서 API 인터페이스를 설계하는 것이 이 task의 목적이다.

1. 요구사항을 확인하고 트랜잭션 단위로 기능을 분해한다.
2. 각 프로젝트의 루트경로의 AGENTS.md 확인하여 가이드 문서를 확인하고 지금까지의 API 설계가 어떻게 되었는지 확인한다.
3. 분해된 기능을 구현하기 위한 API 인터페이스를 초안을 이 파일에 작성한다.
4. 인터페이스의 초안을 작성한 후 각 프로젝트의 코드베이스에서 이를 구현 가능한지 점검한다.
5. 점검 결과를 바탕으로 인터페이스를 수정한다.
6. 마지막으로 개발자에게 검토를 요청한다.

---

## API Interface Draft (Revised after Frontend Analysis)

마이페이지 기능을 구현하기 위한 API 인터페이스 설계안입니다. 프론트엔드(`quiet-chatter-front-end`)의 기존 `api.ts` 및 `AuthContext.tsx` 구조를 분석하여, 연동이 용이하도록 설계하였습니다.

### 1. 내 작성 글 목록 조회 (Get My Talks)
- **URL**: `GET /v1/me/talks`
- **Description**: 내가 작성한 모든 Book Talk 목록을 조회합니다. 프론트엔드에서 도서 상세 정보를 매번 요청하는 비용을 줄이기 위해 도서 요약 정보를 포함합니다.
- **Authentication**: JWT 필요 (Cookie 기반)
- **Response**: `200 OK`
```json
{
  "content": [
    {
      "id": "uuid",
      "content": "string",
      "book": {
        "id": "uuid",
        "title": "string",
        "author": "string",
        "cover": "string"
      },
      "createdAt": "ISO-8601",
      "dateToHidden": "ISO-8601",
      "likeCount": 10,
      "supportCount": 5,
      "isModified": false
    }
  ],
  "page": {
    "size": 10,
    "number": 0,
    "totalElements": 1,
    "totalPages": 1
  }
}
```

### 2. 프로필(닉네임) 변경 (Update Profile)
- **URL**: `PUT /v1/me/profile`
- **Description**: 현재는 닉네임만 변경 가능하지만, 향후 프로필 이미지 등 확장성을 고려하여 `profile` 엔드포인트를 사용합니다.
- **Request Body**:
```json
{
  "nickname": "new_nickname"
}
```
- **Response**: `204 No Content`

### 3. 회원 탈퇴 (Withdrawal)
- **URL**: `DELETE /v1/me`
- **Description**: 회원 상태를 `DEACTIVATED`로 변경하고, 모든 작성글을 숨김(`isHidden=true`) 처리합니다. 또한 서버측 세션(리프레시 토큰 등)을 즉시 무효화합니다.
- **Response**: `204 No Content`

---

## Codebase Feasibility Check

### Frontend (quiet-chatter-front-end)
- **API Integration**: `src/api/api.ts`에 `getMyTalks`, `updateProfile`, `withdraw` 함수를 추가하여 쉽게 통합 가능합니다.
- **State Management**: `AuthContext.tsx`의 `refreshMember`를 활용하여 닉네임 변경 후 UI를 즉시 갱신할 수 있습니다.
- **UI Components**: `src/pages/MyPage.tsx`를 신설하고, `Header.tsx`에서 로그인 상태일 때 "마이페이지" 링크를 노출하도록 수정이 필요합니다.

### Backend (quiet-chatter)
- **Domain**: `Member` 엔티티의 `status`를 `DEACTIVATED`로 변경하는 로직과 `Talk` 엔티티를 일괄 `hide()` 시키는 기능이 구현 가능함을 확인했습니다.
- **DTO**: 기존 `TalkResponse`와 별개로 도서 정보를 포함한 `MyTalkResponse`를 정의하여 데이터 전송 효율을 높일 수 있습니다.

---

## Agent Review Request
설계안에 대한 최종 검토를 요청드립니다.
1. **도서 정보 포함**: `GET /v1/me/talks`에서 `book` 요약 정보를 포함하는 방향으로 결정했습니다. (API 호출 횟수 최적화)
2. **엔드포인트**: 확장성을 고려하여 `PUT /v1/me/profile`을 사용합니다.
3. **탈퇴 로직**: `DELETE /v1/me` 요청 시 백엔드에서 데이터 처리(상태 변경, 글 숨김)와 인증 정보 만료(리프레시 토큰 삭제)를 원자적으로 처리하는 것이 안전하다고 판단됩니다.

검토 후 의견 주시면 바로 구현 단계로 넘어가겠습니다.


## Developer's Review Response : more features required
1. When user is deactivated, we need to block user to login again. 
2. but user can login again if user reactivate the account. 
3. So we need to ask user(deactivated but try logging in) if they want to reactivate the account.
4. This is a new feature. So update [service_specification.md](/service_specification.md) and add design of it in this file.

---

## Additional API Interface: Account Reactivation (Revised)

사용자 재활성화 및 **상태 유지 정책**을 반영한 인터페이스 설계안입니다.

### 1. 계정 상태 확인 및 로그인 차단 (Auth State Check)
- **URL**: `GET /v1/auth/me` (기존 유지 및 확장)
- **Response**: `200 OK`
```json
{
  "isLoggedIn": true,
  "id": "uuid",
  "role": "REGULAR",
  "nickname": "닉네임",
  "status": "DEACTIVATED" 
}
```
- **Flow**: 프론트엔드에서는 `status === "DEACTIVATED"`인 경우, "재활성화 안내 페이지"(`ReactivateConfirm.tsx`)로 이동하여 사용자의 의사를 확인합니다.

### 2. 계정 재활성화 (Reactivate)
- **URL**: `POST /v1/auth/reactivate`
- **Method**: `POST`
- **Description**: 탈퇴 상태인 회원을 다시 `ACTIVE`로 변경합니다. **탈퇴 시 숨겨졌던 글들은 그대로 유지(`isHidden=true`)**되어, 사용자가 마이페이지에서 선택적으로 관리할 수 있도록 합니다. (만료된 글의 노출 방지)
- **Authentication**: JWT 필요
- **Response**: `200 OK`
```json
{
  "status": "ACTIVE"
}
```

---

## Updated Codebase Feasibility Check

### Backend (quiet-chatter)
- **Security**: 탈퇴 상태(`DEACTIVATED`)에서도 로그인은 가능하나, 재활성화 API 외의 기능 접근은 제한되도록 필터링이 필요합니다.
- **Member Domain**: `Member.reactivate()` 메소드를 추가하여 `status`를 `ACTIVE`로 변경합니다.
- **Talk Domain**: 탈퇴 시 숨겨진 글을 재활성화 시 자동으로 공개하지 않으므로, 별도의 일괄 공개 로직은 구현하지 않습니다. (기획서 반영)

### Frontend (quiet-chatter-front-end)
- **Router**: `src/pages/ReactivateConfirm.tsx` 페이지를 신설합니다.
- **Auth Guard**: `AuthContext.tsx`에서 사용자의 `status`를 확인하여 탈퇴 상태일 때 재활성화 유도 UI를 제공합니다.

---

## Agent Review Request (Final Draft)
수정된 기획(재활성화 시 글 상태 유지)을 반영한 최종 설계안입니다.
1. **상태 유지 정책 반영**: 재활성화 시 글을 자동으로 다시 공개하지 않음으로써, 자동 숨김 정책(1년 경과) 등과 충돌하지 않도록 하였습니다.
2. **UX 흐름**: 탈퇴 회원이 로그인 성공 시 즉시 재활성화 페이지로 진입하게 하여 명확한 가이드를 제공합니다.

해당 내용으로 확정을 부탁드리며, 승인 시 바로 구현에 착수하겠습니다.


## Developer's Review Response
- Not now. write the full plan first.

---

## Detailed Implementation Plan

마이페이지 및 계정 재활성화 기능을 구현하기 위한 상세 계획입니다.

### Phase 1: Backend Domain & Application Logic (quiet-chatter)

1.  **Member Domain Update**:
    *   `Member` 엔티티에 `updateNickname(String)`, `deactivate()`, `reactivate()` 메소드 추가.
2.  **Talk Domain & Service Update**:
    *   `TalkRepository`에 `findAllByMemberId(UUID)` 추가.
    *   `TalkCommandService`에 `hideAllByMember(UUID)` 추가 (탈퇴 시 호출).
    *   재활성화 시에는 글 상태를 유지하므로 `showAllByMember`는 구현하지 않음.
3.  **Member Application Service**:
    *   `MemberCommandable` 인터페이스 신설 및 `MemberService` 구현.
    *   닉네임 변경, 회원 탈퇴(Member 상태 변경 + Talk 일괄 숨김 + 리프레시 토큰 삭제), 재활성화 로직 포함.

### Phase 2: Backend API & Security (quiet-chatter)

1.  **DTO 정의**:
    *   `AuthMeResponse`에 `status` 필드 추가.
    *   `MyTalkResponse` (도서 요약 정보 포함) 정의 및 전용 Mapper 구현.
2.  **API Controller 구현**:
    *   `MeApi` (`/v1/me`): `GET /talks`, `PUT /profile`, `DELETE` 구현.
    *   `AuthReactivateApi` (`/v1/auth/reactivate`): `POST` 구현.
3.  **Security Filtering**:
    *   `DEACTIVATED` 상태인 사용자가 `/v1/auth/reactivate`, `/v1/auth/me`, `/v1/auth/logout` 외의 API 호출 시 `403 Forbidden` 또는 전용 에러 코드를 반환하도록 `AuthFilter` 또는 별도 Interceptor 로직 강화.

### Phase 3: Frontend API & Auth State (quiet-chatter-front-end)

1.  **Type Definition**:
    *   `Member` 타입에 `status` 추가.
    *   `MyTalk` 타입 및 관련 인터페이스 정의.
2.  **API Service (`api.ts`)**:
    *   `getMyTalks`, `updateProfile`, `withdraw`, `reactivateAccount` 함수 추가.
3.  **AuthContext 강화**:
    *   `member.status` 변화에 따라 전역적인 대응이 가능하도록 로직 보완.

### Phase 4: Frontend Pages & Components (quiet-chatter-front-end)

1.  **ReactivateConfirm Page**:
    *   탈퇴 상태 사용자를 위한 안내 및 재활성화 동의 버튼 구현.
2.  **MyPage**:
    *   내 활동(작성 글 목록), 프로필 수정(닉네임), 회원 탈퇴 버튼 구현.
3.  **Header & Navigation**:
    *   로그인 상태에 따라 "마이페이지" 메뉴 노출 및 경로 연결.

### Phase 5: Verification

1.  **Backend Test**:
    *   `MemberService` 단위 테스트 및 `MeApi` 통합 테스트 (RestDocs 포함).
2.  **Frontend Test**:
    *   재활성화 흐름 및 마이페이지 기능 동작 확인.
3.  **E2E Test**:
    *   탈퇴 -> 로그인 시도 -> 재활성화 -> 글 상태 확인 시나리오 검증.

---

## Agent Review Request (Final Plan)
상세 구현 계획에 대해 검토를 부탁드립니다. 
- 탈퇴 및 재활성화 로직이 도메인-서비스-API 레이어에 걸쳐 안전하게 설계되었는지?
- 프론트엔드에서 탈퇴 상태를 감지하고 사용자에게 적절한 UX(재활성화 유도)를 제공하는 시점이 적절한지?

검토 후 승인해 주시면 단계별로 구현을 시작하도록 하겠습니다.


## Developer's Review Response
- Not now. write the full plan with designed api spec first.

---

## Full Technical Specification & Implementation Plan (Master Copy)

마이페이지(My Page) 및 계정 재활성화(Reactivation) 기능의 최종 상세 명세 및 구현 계획입니다.

### 1. API Specification

#### [Auth] 계정 상태 확인 및 기본 정보 조회
- **URL**: `GET /v1/auth/me`
- **Method**: `GET`
- **Auth**: JWT Required (Cookie)
- **Response**: `200 OK`
```json
{
  "isLoggedIn": true,
  "id": "uuid",
  "role": "REGULAR",
  "nickname": "조용한독자",
  "status": "ACTIVE | DEACTIVATED"
}
```

#### [Auth] 계정 재활성화
- **URL**: `POST /v1/auth/reactivate`
- **Method**: `POST`
- **Auth**: JWT Required (탈퇴 상태여도 세션은 유효함)
- **Response**: `200 OK`
```json
{
  "status": "ACTIVE"
}
```
- **Note**: 재활성화 시 탈퇴 시점에 숨겨졌던 글들은 그대로 숨김(`isHidden=true`) 상태를 유지합니다.

#### [Me] 내 활동(Talk) 목록 조회
- **URL**: `GET /v1/me/talks`
- **Method**: `GET`
- **Auth**: JWT Required
- **Pagination**: `page`, `size`, `sort` 지원
- **Response**: `200 OK`
```json
{
  "content": [
    {
      "id": "uuid",
      "content": "250자 이내의 독서평",
      "book": {
        "id": "uuid",
        "title": "책 제목",
        "author": "저자",
        "cover": "이미지 URL"
      },
      "createdAt": "2024-02-24T10:00:00Z",
      "dateToHidden": "2025-02-24",
      "likeCount": 5,
      "supportCount": 2,
      "isModified": false
    }
  ],
  "page": { "size": 10, "number": 0, "totalElements": 1, "totalPages": 1 }
}
```

#### [Me] 프로필(닉네임) 수정
- **URL**: `PUT /v1/me/profile`
- **Method**: `PUT`
- **Auth**: JWT Required
- **Request Body**:
```json
{
  "nickname": "변경할닉네임"
}
```
- **Response**: `204 No Content`

#### [Me] 회원 탈퇴
- **URL**: `DELETE /v1/me`
- **Method**: `DELETE`
- **Auth**: JWT Required
- **Logic**: 회원 상태 `DEACTIVATED` 변경 + 모든 글 `isHidden=true` 처리 + 리프레시 토큰 무효화
- **Response**: `204 No Content`

### 2. Implementation Roadmap

#### [Phase 1] Backend Domain & Core Service
1.  **Member Domain**: `status` 필드 관리 및 상태 전이(`deactivate`, `reactivate`) 로직 구현.
2.  **Talk Domain**: `member_id` 인덱스 확인 및 `TalkRepository.findAllByMemberId` 쿼리 추가.
3.  **MemberService**: 탈퇴 시 `TalkCommandService.hideAllByMember`를 트랜잭션 내에서 호출하도록 구현.

#### [Phase 2] Backend API & Security Layer
1.  **DTO & Mapper**: `MyTalkResponse`에 `Book` 요약 정보를 포함하기 위해 `BookQueryable` 의존성 주입 및 매핑 로직 작성.
2.  **Security Filter**: `DEACTIVATED` 상태인 사용자가 허용된 API(me, reactivate, logout) 외의 요청을 보낼 경우 차단하는 로직 추가.
3.  **RestDocs**: 신규 API 5종에 대한 문서화 테스트 코드 작성.

#### [Phase 3] Frontend Foundation & Pages
1.  **API Client**: `src/api/api.ts`에 신규 엔드포인트 연동 함수 추가.
2.  **Auth Guard**: `AuthContext`에서 로그인 성공 시 `status`를 체크하여 `DEACTIVATED`이면 `/reactivate` 안내 페이지로 강제 리다이렉트.
3.  **MyPage**: 활동 내역 리스트(MUI 활용) 및 프로필 수정 폼 구현.

#### [Phase 4] Verification & Delivery
1.  **Integration Test**: 회원 탈퇴 -> 재로그인 -> 재활성화 흐름의 E2E 테스트 수행.
2.  **Validation**: 재활성화 후 과거에 숨겨졌던 글이 다시 노출되지 않는지 정책 준수 여부 확인.

---

## Agent Review Request (Master Plan)
위의 마스터 플랜(상세 API 스펙 포함)을 최종 확인 부탁드립니다. 
이 계획은 기획서(`service_specification.md`)의 계정 재활성화 및 글 상태 유지 정책을 완벽히 반영하고 있습니다. 승인 시 Phase 1부터 순차적으로 작업을 진행하겠습니다.


## Developer's Review Response
- 당장은 구현 하지 않음
- 탈퇴한 계정으로 로그인할시 로그인 실패로 처리하도록 수정하도록 함. 즉 탈퇴한 계정은 세션을 만들지 못하도록 해야 관리가 쉬움.
- 다만 탈퇴한 계정으로 로그인 시도 시 멤버 ID를 서버에서 응답값으로 전달받을 수 있도록 설계필요. 이 응답값을 가지고 프론트엔드에서 탈퇴한 계정임을 인지하고, 재활성화 페이지로 안내하도록 구현하는 방식으로 설계 변경필요. 
- 서버에서 로그인 실패에 따른 응답 코드를 정의할 필요가 있음. 
    - RFC 7807(Problem Details for HTTP APIs) 의 type을 사용하도록 하도록 설계필요. e.g. "type": "/errors/member-deactivated"
    - 예시 
    ```json
    {
        "type": "/errors/member-deactivated",
        "status": 401,
        "memberId": "123e4567-e89b-12d3-a456-426614174000"
    }
    ```
    - 해당 /errors/{error-code} 상대경로로 GET 요청시에 정적페이지를 서빙하지 않고 json 으로 응답 필요 
    ```json
    {
        "title": "Member Deactivated",
        "detail": "Your account has been deactivated",
        "resolution": "If you want to reactivate your account"
    }
    ```
- 재활성화 페이지는 별도의 페이지로 구현하지 않고, 로그인 성공 직후 탈퇴한 계정임이 확인될 경우 모달창을 띄워 재활성화 여부를 묻는 방식으로 구현하도록 함.
- Rewrite all base on this review.